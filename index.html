<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART BUS MANAGER v4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	
	<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #005a9c; --secondary: #6c757d; --success: #28a745;
            --warning: #ffc107; --danger: #dc3545; --light: #f8f9fa;
            --dark: #343a40; --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 0; background-color: #eef2f7; color: #333; line-height: 1.6; }

        /* --- UI LOGIN PREMIUM --- */
        #login-page { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: url('https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&q=80&w=2069') no-repeat center center/cover;
            display: flex; align-items: center; justify-content: center; z-index: 9999; 
        }

        #login-page::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(0, 90, 156, 0.8), rgba(0, 61, 107, 0.9));
            z-index: 1;
        }

        .login-card { 
            position: relative; z-index: 2;
            background: rgba(255, 255, 255, 0.95); padding: 40px; 
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
            width: 90%; max-width: 400px; text-align: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }

        .login-logo {
            background: var(--primary); color: white; width: 70px; height: 70px;
            line-height: 70px; border-radius: 50%; font-size: 2rem;
            margin: 0 auto 20px; box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: center;
        }

        .login-card h2 { margin-bottom: 5px; color: var(--dark); font-weight: 800; }
        .login-card p { color: #666; font-size: 0.9rem; margin-bottom: 25px; }

        .login-card select, .login-card input { 
            width: 100%; padding: 14px; margin: 10px 0; 
            border: 1.5px solid #eee; border-radius: 10px; font-size: 1rem; 
            transition: 0.3s; background: #f9f9f9; box-sizing: border-box;
        }

        .login-card input:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(0,90,156,0.1); }

        .btn-login {
            width: 100%; padding: 14px; border-radius: 10px; 
            background: var(--primary); color: white; font-weight: bold;
            font-size: 1rem; cursor: pointer; border: none; margin-top: 15px;
            transition: 0.3s; box-shadow: 0 4px 12px rgba(0,90,156,0.3);
            display: block;
        }

        .btn-login:hover { background: #004a80; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,90,156,0.4); }

        /* --- CSS APLIKASI UTAMA --- */
        #main-app { display: none; }
        .header {
    background: linear-gradient(135deg, var(--primary), #003d6b);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 1000;
    
    /* TAMBAHKAN ATAU PASTIKAN KODE DI BAWAH INI ADA */
    width: 100%; 
    box-sizing: border-box; /* Agar padding tidak menambah lebar elemen */
    left: 0;
}
        .header h1 { margin: 0; font-size: 1.3rem; letter-spacing: 1px; }
        .container { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 20px; 
    padding: 20px; 
    /* Ubah max-width menjadi 100% agar memenuhi layar */
    max-width: 98%; 
    margin: auto; 
}
@media (min-width: 1024px) { 
    .container { 
        /* Kita perbesar porsi Main Content (Kalender) menjadi 2.2fr */
        grid-template-columns: 2.2fr 0.8fr; 
    } 
}

/* Dan pastikan sidebar-grid cuma 1 kolom */
.sidebar-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 15px; 
    align-items: start;
}
        @media (max-width: 1200px) {
    .sidebar-grid {
        grid-template-columns: 1fr; /* Jadi satu kolom kalau layar mulai sempit */
    }
}

        .card { background: white; padding: 18px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; border: none; }
        .card h3 { margin-top: 0; color: var(--primary); font-size: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .filter-box { background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .filter-box label { font-size: 0.7rem; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .filter-box input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        .stat-card { padding: 12px; border-radius: 10px; background: var(--light); text-align: center; border: 1px solid #e0e0e0; }
        .stat-card span { font-size: 0.75rem; color: #666; font-weight: bold; }
        .stat-card strong { display: block; font-size: 1rem; margin-top: 4px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { border: 1px solid #eee; min-height: 100px; padding: 6px; font-size: 0.8em; cursor: pointer; border-radius: 8px; background: #fff; }
        .day:hover { background: #f0f7ff; }
        .day.empty { background: #f9f9f9; border: none; }
        .event { font-size: 0.7rem; padding: 3px 5px; border-radius: 4px; color: white; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-gray { background: var(--secondary); color: white; }
        .info-item { padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.06); font-size: 0.85rem; }
        .info-item strong { display: block; font-size: 1rem; color: var(--primary); margin-bottom: 5px; }
        .detail-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 5px; }
        .badge-lunas { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-dp { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-blm { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
/* Kotak Biru Pilihan Bus - Versi Minimalis */
.bus-tag {
    background: var(--primary);
    color: white;
    padding: 2px 8px; /* Diperkecil dari sebelumnya */
    border-radius: 4px; /* Kotak sedikit membulat lebih hemat tempat dibanding oval */
    font-size: 0.7rem; /* Ukuran tulisan diperkecil */
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin: 2px; /* Jarak antar kotak */
    border: 1px solid rgba(255,255,255,0.2);
}

.bus-tag b {
    cursor: pointer;
    color: #ffc107;
    font-size: 1rem;
    line-height: 1;
}

.bus-tag b:hover {
    color: #ff4d4d; /* Berubah merah saat mau dihapus */
}

/* Tambahan: Supaya kontainer pembungkusnya tidak kaku */
#selected-bus-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-content: flex-start;
    padding: 5px !important;
}
		.bus-tag b { cursor: pointer; color: #ffc107;  font-size: 1.1rem; }
		.bus-tag b:hover { color: white; } .pickup-box { background: #fff8e1; padding: 8px; border-radius: 6px; border-left: 3px solid #ffc107; margin-top: 5px; font-size: 0.8rem; }
		

		
		
        .modal { 
    display: none; 
    position: fixed; 
    z-index: 3000 !important; /* Naikkkan ke 3000 agar di atas segalanya */
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
}
        .modal-content { background: white; margin: 5vh auto; padding: 25px; width: 90%; max-width: 550px; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.8rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        .chart-container { margin-top: 25px; padding-top: 15px; border-top: 1px solid #f0f0f0; height: 280px; }
    </style>
</head>
<body>

<div id="login-page">
    <div class="login-card">
        <div class="login-logo" style="background: none; box-shadow: none; width: 100%; height: auto; margin-bottom: -110px;">
    <img src="https://raw.githubusercontent.com/smartapps-web/tisalgroup/main/logo.png" 
         alt="Logo Utama Smart Bus Manager" 
         style="width: 380px; height: auto; object-fit: contain;">
</div>
        
        <p style="margin-bottom: -10px; font-weight: 500; color: #666;">Dedicated to :</p>
        
        <h2 style="font-size: 2rem; margin-top: 0; margin-bottom: -20px; color: var(--primary); letter-spacing: 0px;">TISAL Group</h2>
        
        <p style="margin-bottom: 20px; font-size: 0.85rem; color: #888;">Bus Pariwisata Dengan Armada Kelas Eksekutif</p>
        
        <div style="text-align: left; margin-bottom: -10px;"><label style="font-size: 0.8rem; font-weight: bold; color: #555;">Pilih Pengguna:</label></div>
<select id="user-select">
    <option value="Dany">Dany (Admin 1)</option>
    <option value="Pepik">Pepik (Admin 2)</option>
    <option value="Owner">Owner (Pemilik)</option>
	<option value="Admin">Admin Utama</option>
</select>
        
        <div style="text-align: left; margin-bottom: -10px;"><label style="font-size: 0.8rem; font-weight: bold; color: #555;">Password:</label></div>
        <input type="password" id="user-pass" placeholder="masukkan password" onkeypress="if(event.key === 'Enter') handleLogin()">
        
        <button class="btn-login" onclick="handleLogin()">MASUK KE SISTEM</button>
        
        <div style="margin-top: 15px; font-size: 0.75rem; color: #999;">
            SMART BUS MANAGER v4.0 <br>
            &copy; 2026 Rahmat Saleh
        </div>
    </div>
</div>

    <div id="main-app">
<header class="header" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <img src="https://raw.githubusercontent.com/smartapps-web/tisalgroup/main/logo2.png" 
     alt="Logo Header" 
     style="height: 80px; width: auto; filter: brightness(0) invert(1);">
        <div>
            <h1 style="margin: 0; font-size: 1.3rem;">SMART BUS MANAGER <span style="font-weight:300">v4.0</span></h1>
            <small id="current-user-display" style="color: #fff; opacity: 0.9; font-weight: bold;"></small>
        </div>
    </div>

    <div style="display: flex; gap: 8px; margin-left: auto;">
        <button class="btn-orange" onclick="openAccountSettings()">‚öôÔ∏è Setting Akun</button>
        <button class="btn-red" style="padding: 5px 10px;" onclick="handleLogout()">üö™ Log Out</button>
        <button class="btn-green" onclick="openExportModal()">üìä Export Data</button>
        <button class="btn-gray" onclick="exportBackup()">üì• Backup All</button>
        <button class="btn-gray" onclick="document.getElementById('importFile').click()">üì§ Restore</button>
		<div id="network-status" style="display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; border: 1px solid #ddd; background: #fff; vertical-align: middle;">
        <span id="status-dot" style="height: 8px; width: 8px; border-radius: 50%; display: inline-block;"></span>
        <span id="status-text">Mengecek...</span>
    </div>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</header>

        <div class="container">
            <div class="main-content">
                <div id="legal-alerts"></div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <div>
                            <button class="btn-blue" onclick="changeMonth(-1)">‚óÄ</button>
                            <span id="month-year" style="font-weight:bold; font-size:1.1rem; margin:0 10px; min-width:140px; display:inline-block; text-align:center;">Bulan</span>
                            <button class="btn-blue" onclick="changeMonth(1)">‚ñ∂</button>
                        </div>
                        <div style="display:flex; gap:8px;">				
						<button class="btn-green" onclick="openBusStatsModal()">üìä Statistik Armada</button>
                            <button class="btn-orange" onclick="openExpenseModal()">üí∏ Biaya OPS</button>
                            <button class="btn-gray" onclick="openFleetModal()">üöå Armada</button>
                            <button class="btn-blue" onclick="openScheduleModal()">üóìÔ∏è Jadwal</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>

                <div class="card">
                    <h3>üí∞ Ringkasan Keuangan (Bulan Ini)</h3>
                    <div class="stat-grid">
                        <div class="stat-card"><span>Omzet (Target)</span><strong id="st-omzet">0</strong></div>
                        <div class="stat-card" style="background:#fff9f9; border: 1px solid #f5c6cb;"><span>Piutang (Sisa)</span><strong id="st-piutang" style="color:var(--danger)">0</strong></div>
                        <div class="stat-card"><span>Masuk (Cash)</span><strong id="st-masuk">0</strong></div>
                        <div class="stat-card"><span>Biaya Ops</span><strong id="st-keluar">0</strong></div>
                        <div class="stat-card" style="background:#e7f3ff"><span>Laba Bersih</span><strong id="st-laba">0</strong></div>
                    </div>
                    <div class="chart-container"><canvas id="financeChart"></canvas></div>
                </div>

                <div class="card">
                    <h3>üìä Detail Pengeluaran Operasional</h3>
                    <div style="overflow-x:auto; max-height: 350px;">
                        <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0;">
                                    <th style="padding:10px; text-align:left;">Tgl</th>
                                    <th style="padding:10px; text-align:left;">Unit</th>
                                    <th style="padding:10px; text-align:left;">Kategori</th>
                                    <th style="padding:10px; text-align:left;">Ket</th>
                                    <th style="padding:10px; text-align:right;">Nominal</th>
                                    <th style="padding:10px; text-align:center;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="list-expenses-body"></tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="background: var(--primary); color: white; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 0.8rem;">SB</div>
                            <div>
                                <div style="font-size: 0.8rem; font-weight: bold; color: var(--primary);">SMART BUS MANAGER v4.0</div>
                                <div style="font-size: 0.7rem; color: #888;">Sistem Manajemen Operasional & Penjadwalan</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: #555;">Developed by: <strong>Rahmat Saleh</strong></div>
                            <div style="font-size: 0.7rem; color: #999;">Contact: 0190739512 (WA Only)</div>
                        </div>
                    </div>
                </div>
            </div>


<div id="modal-bus-stats" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3>üìà Performa & Histori Armada</h3>
            <button class="btn-red" onclick="closeModal()">X</button>
        </div>
		
<div style="margin-bottom: 15px; text-align: right;">
    <button class="btn-green" onclick="exportBusStatsToExcel()">üì• Download Laporan (Excel)</button>
</div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div style="flex: 1;">
                <label style="font-size: 0.8rem; font-weight: bold;">Pilih Bulan:</label>
                <select id="stats-month-filter" onchange="openBusStatsModal()" style="width: 100%; padding: 8px;">
                    <option value="all">-- Semua Bulan --</option>
                    <option value="01">Januari</option>
                    <option value="02">Februari</option>
                    <option value="03">Maret</option>
                    <option value="04">April</option>
                    <option value="05">Mei</option>
                    <option value="06">Juni</option>
                    <option value="07">Juli</option>
                    <option value="08">Agustus</option>
                    <option value="09">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
            </div>
<div style="flex: 1;">
    <label style="font-size: 0.8rem; font-weight: bold;">Pilih Tahun:</label>
    <select id="stats-year-filter" onchange="openBusStatsModal()" style="width: 100%; padding: 8px;">
    </select>
</div>
        </div>
        
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: var(--primary); color: white;">
                        <th style="padding:10px;">Nama Unit</th>
                        <th style="padding:10px;">Job</th>
                        <th style="padding:10px;">Omzet</th>
                        <th style="padding:10px;">Biaya Ops</th>
                        <th style="padding:10px;">Profit</th>
                    </tr>
                </thead>
                <tbody id="bus-performance-body"></tbody>
            </table>
        </div>
        <button class="btn-gray" style="width:100%; margin-top:20px;" onclick="closeModal()">TUTUP</button>
    </div>
</div>


            <div class="sidebar-grid">
                <div class="sidebar-section">
<div class="card">
    <h3>üìÖ Jadwal Terdekat</h3>
	
	<div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
        <button class="btn-gray" style="padding: 4px 10px; font-size: 0.7rem; min-width: 60px;" onclick="setQuickFilter('')">Semua</button>
        <button class="btn-green" style="padding: 4px 10px; font-size: 0.7rem; min-width: 60px;" onclick="setQuickFilter('Lunas')">Lunas</button>
        <button class="btn-orange" style="padding: 4px 10px; font-size: 0.7rem; min-width: 60px; background: #ffc107; color: #856404;" onclick="setQuickFilter('DP')">DP</button>
        <button class="btn-red" style="padding: 4px 10px; font-size: 0.7rem; min-width: 60px;" onclick="setQuickFilter('belum bayar')">Belum</button>
    </div>
	
    <div class="filter-box" style="grid-template-columns: 1fr; gap: 10px;">
        <div>
            <label>Cari Nama / HP / Alamat / Tujuan / Nama Bus / Nopol :</label>
            <input type="text" id="search-input" placeholder="üîç Ketik kata kunci..." 
                   onkeyup="renderSidebar()" 
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label>Dari:</label><input type="date" id="filter-start" onchange="renderSidebar()"></div>
            <div><label>Sampai:</label><input type="date" id="filter-end" onchange="renderSidebar()"></div>
        </div>
    </div>
    <div id="list-upcoming"></div>
</div>


                </div>

            </div>
        </div>
    </div>

<div id="modal-account" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3>üîê Pengaturan Password</h3>
            <button class="btn-red" onclick="closeModal()" style="padding: 5px 10px;">X</button>
        </div>

        <div class="form-group">
            <label>Password Dany (Admin 1)</label>
            <input type="text" id="set-pass-dani">
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>Password Pepik (Admin 2)</label>
            <input type="text" id="set-pass-pepik">
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>Password Admin Utama</label>
            <input type="text" id="set-pass-admin">
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>Password Owner (Pemilik)</label>
            <input type="text" id="set-pass-owner">
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-green" style="flex:2; padding: 12px;" onclick="saveAccountSettings()">‚úÖ SIMPAN</button>
            <button class="btn-gray" style="flex:1; padding: 12px;" onclick="closeModal()">‚úñ BATAL</button>
        </div>
    </div>
</div>

    <div id="modal-expense" class="modal"><div class="modal-content">
        <h2 id="expense-modal-title">Catat Biaya Operasional</h2>
        <form id="expense-form">
            <input type="hidden" id="edit-expense-id">
            <div class="form-group"><label>Tanggal</label><input type="date" id="e-date" required></div>
            <div class="form-group"><label>Unit Bus Terkait</label><select id="e-bus" required></select></div>
            <div class="form-group"><label>Kategori</label><select id="e-cat"><option value="Solar">Solar / BBM</option><option value="Tol">Biaya Tol</option><option value="Gaji Sopir">Gaji Sopir</option><option value="Gaji Kernet">Gaji Kernet</option><option value="Service">Service</option><option value="Lainnya">Lainnya</option></select></div>
            <div class="form-group"><label>Nominal (Rp)</label><input type="number" id="e-amount" required></div>
            <div class="form-group"><label>Keterangan</label><input type="text" id="e-desc"></div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button type="submit" id="btn-save-expense" class="btn-orange" style="flex:2; justify-content:center">SIMPAN BIAYA</button><button type="button" class="btn-gray" style="flex:1" onclick="closeModal()">BATAL</button></div>
        </form>
    </div></div>

<div id="modal-form" class="modal">
    <div class="modal-content">
        <h2 id="sched-modal-title">Input Jadwal Sewa</h2>
        <form id="schedule-form">
            <input type="hidden" id="edit-id">
            
            <div class="form-group">
                <label>Nama Trip / Tujuan</label>
                <input type="text" id="f-trip" required>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; background: #f0f7ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; margin-bottom: 10px;">
                <div class="form-group">
                    <label>üìÖ Berangkat</label>
                    <input type="date" id="f-date" required onchange="calculateDuration()">
                    <input type="time" id="f-time" required style="margin-top:5px;">
                </div>
                <div class="form-group">
                    <label>üèÅ Estimasi Pulang</label>
                    <input type="date" id="f-date-end" required onchange="calculateDuration()">
                    <input type="time" id="f-time-end" required style="margin-top:5px;">
                </div>
            </div>

            <div style="margin-bottom: 15px; font-size: 0.8rem; color: var(--primary); font-weight: bold;">
                ‚è±Ô∏è Durasi Sewa: <span id="f-duration">1</span> Hari
            </div>

            <div class="form-group">
                <label>üöå Unit Armada (Bisa pilih lebih dari satu)</label>
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input list="bus-options" id="f-bus-input" placeholder="Cari bus..." style="flex: 1;" onchange="addBusToList(this.value)">
                    <datalist id="bus-options"></datalist>
                </div>
                <div id="selected-bus-list" style="display: flex; flex-wrap: wrap; gap: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; min-height: 40px; background: #fff;"></div>
                <input type="hidden" id="f-bus-ids">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 10px;">
                <div class="form-group">
                    <label>üî¢ Jumlah Seat (Kursi)</label>
                    <input type="text" id="f-seats" placeholder="Misal: 50">
                </div>
                <div class="form-group">
                    <label>‚ú® Fasilitas Tambahan</label>
                    <input type="text" id="f-extra-features" placeholder="Misal: Selimut, Snack">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Nama Pemesan</label><input type="text" id="f-cust" required></div>
                <div class="form-group"><label>Nomor WA</label><input type="text" id="f-phone" required></div>
            </div>
            
            <div class="form-group"><label>üè† Alamat Lengkap</label><textarea id="f-addr" rows="2"></textarea></div>
            <div class="form-group"><label>üìç Titik Jemput</label><textarea id="f-pickup" rows="2"></textarea></div>
            
            <div class="form-group"><label>Harga Sewa (Rp)</label><input type="number" id="f-price" required></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group">
                    <label>Status Pembayaran</label>
                    <select id="f-status" onchange="toggleDP(this.value)">
                        <option value="Belum Bayar">Belum Bayar</option>
                        <option value="DP">DP (Uang Muka)</option>
                        <option value="Lunas">Lunas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Metode</label>
                    <select id="f-payment-method">
                        <option value="Tunai">üíµ Tunai</option>
                        <option value="Transfer">üì± Transfer</option>
                    </select>
                </div>
            </div>

            <div id="dp-group" class="form-group" style="display:none; background:#f0fff4; padding:10px; border-radius:8px;">
                <label>Jumlah DP (Rp)</label><input type="number" id="f-dp">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn-blue" style="flex:2; justify-content:center">SIMPAN JADWAL</button>
                <button type="button" class="btn-gray" style="flex:1" onclick="closeModal()">BATAL</button>
            </div>
        </form>
    </div>
</div>

    <div id="modal-fleet" class="modal"><div class="modal-content">
        <h3>Kelola Armada</h3>
        <div id="fleet-list" style="margin-bottom:15px; max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div>
<form id="fleet-form">
    <input type="hidden" id="bus-edit-id">
    <div class="form-group">
        <label id="fleet-form-title">Tambah Unit Baru</label>
        <input type="text" id="bus-name" required placeholder="Nama Unit (Contoh: Big Bus Jetbus 5)" onkeyup="autoFillCategory(this.value)">
    </div>
    
    <div class="form-group">
        <label>Kategori (Tampil di Invoice)</label>
        <input type="text" id="bus-category" required placeholder="Contoh: Big Bus / Medium Bus">
        <small style="color: #666; font-size: 0.7rem;">*Hanya kata ini yang akan muncul di invoice pelanggan.</small>
    </div>

    <div class="form-group">
        <label>Plat Nomor</label>
        <input type="text" id="bus-plate" required placeholder="Nopol (Contoh: B 1234 TSL)">
    </div>

    <div class="form-group">
        <label>Fasilitas & Spesifikasi Unit</label>
        <input type="text" id="bus-features" placeholder="Contoh: AC, TV, Kulkas, Karaoke, Wifi">
    </div>

<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
    <div class="form-group">
        <label>üìÖ Pajak STNK</label>
        <input type="date" id="bus-stnk">
    </div>
    <div class="form-group">
        <label>üõ†Ô∏è Masa KIR</label>
        <input type="date" id="bus-kir">
    </div>
    <div class="form-group">
        <label>üìë Ijin KPS</label>
        <input type="date" id="bus-kps"> </div>
</div>

    <button type="submit" id="btn-save-bus" class="btn-green" style="width:100%">SIMPAN UNIT</button>
    <button type="button" id="btn-cancel-bus" class="btn-gray" style="width:100%; margin-top:5px; display:none;" onclick="resetFleetForm()">BATAL</button>
    <button type="button" class="btn-gray" style="width:100%; margin-top:5px;" onclick="closeModal()">TUTUP</button>
</form>
    </div></div>

     <div id="modal-export" class="modal"><div class="modal-content">
        <h2>Export Laporan Bulanan</h2>
        <div class="form-group"><label>Pilih Periode:</label><input type="month" id="export-period" required></div>
        <div style="display:flex; gap:10px; margin-top:20px;"><button onclick="processExport()" class="btn-green" style="flex:2; justify-content:center">DOWNLOAD EXCEL (.XLS)</button><button onclick="closeModal()" class="btn-gray" style="flex:1">BATAL</button></div>
    </div></div>

<div id="modal-surat-jalan" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3>üöö Input Operasional Driver</h3>
                <button class="btn-red" onclick="closeModal()">X</button>
            </div>
            
            <input type="hidden" id="sj-id"> <div class="form-group">
                <label>‚õΩ Biaya Solar</label>
                <input type="number" id="sj-fuel" placeholder="Masukkan Nominal Solar">
            </div>
            <div class="form-group">
                <label>üõ£Ô∏è Biaya Tol</label>
                <input type="number" id="sj-toll" placeholder="Masukkan Nominal Tol/Parkir">
            </div>
            <div class="form-group">
                <label>üí∞ Tips Driver</label>
                <input type="number" id="sj-tips" placeholder="Masukkan Nominal Tips/Makan">
            </div>
            <div class="form-group">
                <label>üìù Keterangan Tambahan (Opsional)</label>
                <input type="text" id="sj-note" placeholder="Misal: Lewat Jalur Selatan">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-blue" style="flex:1; padding: 12px;" onclick="saveSuratJalanData()">üíæ SIMPAN</button>
                <button class="btn-green" style="flex:1; padding: 12px;" onclick="printSuratJalanProcess()">üñ®Ô∏è CETAK</button>
            </div>
            <button class="btn-gray" style="width:100%; margin-top:10px;" onclick="closeModal()">TUTUP</button>
        </div>
    </div>
	
    <script>
const KEYS = { 
    BUS: 'tisal_bus_v1', 
    SCHED: 'tisal_sched_v1', 
    EXP: 'tisal_exp_v1', 
    USER: 'tisal_session', 
    PASS: 'tisal_passwords' 
};
        let buses = [], schedules = [], expenses = [], currDate = new Date();
        let currentUser = null;
        let passwords = { "Dany": "123", "Pepik": "123", "Admin": "madhacker", "Owner": "tisal2026" };
        let myChart = null;
        let currentEditExpenseId = null;

const firebaseConfig = { 
    databaseURL: "https://bus-managemen-5fca8-default-rtdb.asia-southeast1.firebasedatabase.app/" 
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const FIREBASE_URL = "https://bus-managemen-5fca8-default-rtdb.asia-southeast1.firebasedatabase.app/tisalgroup.json";

        // --- LOGIN LOGIC ---
        function handleLogin() {
            const user = document.getElementById('user-select').value;
            const pass = document.getElementById('user-pass').value;
            const storedPass = JSON.parse(localStorage.getItem(KEYS.PASS)) || passwords;

            if (pass === storedPass[user]) {
                currentUser = user;
                sessionStorage.setItem(KEYS.USER, user);
                showMainApp();
            } else { alert("Password Salah!"); }
        }

        function handleLogout() { sessionStorage.removeItem(KEYS.USER); location.reload(); }




let tempSelectedBuses = [];

function addBusToList(val) {
    const options = document.querySelectorAll('#bus-options option');
    let busFound = null;
    
    options.forEach(opt => {
        if(opt.value === val) {
            // Kita ambil ID dan Nama Bus-nya
            busFound = { id: opt.getAttribute('data-id'), name: val };
        }
    });

    if (busFound && !tempSelectedBuses.some(b => b.id == busFound.id)) {
        tempSelectedBuses.push(busFound);
        renderSelectedBuses(); // Fungsi untuk memunculkan tag biru
        document.getElementById('f-bus-input').value = ''; // Kosongkan lagi inputnya
    }
}

function removeBusFromList(id) {
    tempSelectedBuses = tempSelectedBuses.filter(b => b.id != id);
    renderSelectedBuses();
}

function renderSelectedBuses() {
    const container = document.getElementById('selected-bus-list');
    const hiddenInput = document.getElementById('f-bus-ids');
    
    container.innerHTML = tempSelectedBuses.map(b => `
        <div class="bus-tag">
            ${b.name} <b onclick="removeBusFromList('${b.id}')">√ó</b>
        </div>
    `).join('');
    
    hiddenInput.value = tempSelectedBuses.map(b => b.id).join(',');
}






// --- FUNGSI MODAL SURAT JALAN ---



// 1. Kita buat fungsi simpan jadi "Silent" (tanpa alert)
function saveSuratJalanData(isSilent = false) {
    const id = document.getElementById('sj-id').value;
    const index = schedules.findIndex(x => x.id == id);
    
    if (index !== -1) {
        // 1. Ambil data dari input modal
        const fuel = parseInt(document.getElementById('sj-fuel').value) || 0;
        const toll = parseInt(document.getElementById('sj-toll').value) || 0;
        const tips = parseInt(document.getElementById('sj-tips').value) || 0;
        const sjNote = document.getElementById('sj-note').value;

        // 2. Update variabel lokal
        schedules[index].fuel = fuel;
        schedules[index].toll = toll;
        schedules[index].tips = tips;
        schedules[index].sjNote = sjNote;
        
        // 3. Langsung tembak ke Firebase agar permanen
        // Gunakan fungsi save() bawaan aplikasi kamu atau panggil update khusus
        if (typeof save === "function") {
            save(); 
        }

        // 4. Kasih feedback kalau tidak silent
        if (!isSilent) {
            alert("‚úÖ Data Operasional Terkunci Permanen!");
        }
    }
}

// 2. Pas cetak, panggil simpan versi SILENT
async function printSuratJalanProcess() {
    const id = document.getElementById('sj-id').value;
    
    // Simpan dulu secara silent
    saveSuratJalanData(true);
    
    // Beri jeda 500ms agar database sempat memproses simpan sebelum buka window baru
    setTimeout(() => {
        printSuratJalan(id);
    }, 500);
}

function printSuratJalan(id) {
    const s = schedules.find(x => x.id == id), b = buses.find(x => x.id == s.busId);
    if (!s) return;
    
    // URL LOGO DARI GITHUB (Ganti 'nama-user' dan 'nama-repo' sesuai akunmu)
    const logoUrl = "https://raw.githubusercontent.com/smartapps-web/tisalgroup/main/tisal_logo_transp.png";

    const pWin = window.open('', '_blank');
    pWin.document.write(`
    <html>
    <head>
        <title>Surat_Jalan_${s.cust}</title>
        <style>
            body { font-family: sans-serif; padding: 30px; line-height: 1.4; color: #333; }
            .header { 
                display: flex; 
                align-items: center; 
                border-bottom: 3px solid #000; 
                padding-bottom: 10px; 
                margin-bottom: 20px; 
            }
            .logo { width: 80px; height: auto; margin-right: 20px; }
            .header-text { flex-grow: 1; }
            .header-text h1 { margin: 0; font-size: 24px; color: #000; }
            .header-text p { margin: 2px 0; font-size: 12px; color: #444; }
            
            .content-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
            .content-table td { padding: 8px; vertical-align: top; border-bottom: 1px solid #eee; }
            .ops-box { border: 1px solid #000; padding: 15px; background: #f9f9f9; margin: 20px 0; }
            .ops-table { width: 100%; border-collapse: collapse; }
            .ops-table td { padding: 8px; }
            .signature { display: flex; justify-content: space-between; margin-top: 50px; text-align: center; }
            @media print { .no-print { display: none; } }
        </style>
    </head>
    <body>
        <div class="header">
            <img src="${logoUrl}" class="logo" alt="Logo Tisal">
            <div class="header-text">
                <h1>TISAL GROUP</h1>
                <p>Sistem Manajemen Bus Pariwisata & Transportasi</p>
                <p>Jl. Raya Krajan - Semin, Gunungkidul, DIY</p>
            </div>
            <div style="text-align: right;">
                <h3 style="margin: 0; color: #444;">SURAT JALAN</h3>
                <p style="margin: 0; font-size: 11px;">No: SJ/${s.id}</p>
            </div>
        </div>

        <table class="content-table">
            <tr><td width="180"><b>Tujuan Trip</b></td><td>:&nbsp; ${s.trip}</td></tr>
            <tr><td><b>Hari / Tanggal</b></td><td>:&nbsp; ${new Date(s.date).toLocaleDateString('id-ID', {weekday:'long', day:'2-digit', month:'long', year:'numeric'})}</td></tr>
            <tr><td><b>Jam Standby</b></td><td>:&nbsp; ${s.time || '-'} WIB</td></tr>
            <tr><td><b>Unit Armada</b></td><td>:&nbsp; ${b?.name || '-'} (${b?.plate || '-'})</td></tr>
            <tr><td><b>Kapasitas</b></td><td>:&nbsp; ${s.seats || '-'} Seat</td></tr>
            <tr><td><b>Fasilitas</b></td><td>:&nbsp; ${[b?.features, s.extraFeatures].filter(x => x).join(', ') || '-'}</td></tr>
            <tr><td><b>Titik Jemput</b></td><td>:&nbsp; ${s.pickup || '-'}</td></tr>
            <tr><td><b>Nama Pemesan</b></td><td>:&nbsp; ${s.cust} (${s.phone})</td></tr>
        </table>

        <div class="ops-box">
            <h4 style="margin-top:0; border-bottom: 1px solid #000; padding-bottom:5px;">RINCIAN BIAYA OPERASIONAL (UANG JALAN)</h4>
            <table class="ops-table">
                <tr><td>Uang Solar / BBM</td><td align="right">Rp ${(s.fuel || 0).toLocaleString('id-ID')}</td></tr>
                <tr><td>Uang Tol & Parkir</td><td align="right">Rp ${(s.toll || 0).toLocaleString('id-ID')}</td></tr>
                <tr><td>Tips Driver / Makan</td><td align="right">Rp ${(s.tips || 0).toLocaleString('id-ID')}</td></tr>
                <tr style="font-size: 1.1rem; background: #eee; font-weight: bold;">
                    <td>TOTAL TERIMA DRIVER</td>
                    <td align="right">Rp ${((s.fuel || 0) + (s.toll || 0) + (s.tips || 0)).toLocaleString('id-ID')}</td>
                </tr>
            </table>
            ${s.sjNote ? `<p style="margin-top:10px; font-size:0.9rem;"><b>Ket:</b> ${s.sjNote}</p>` : ''}
        </div>

        <div class="signature">
            <div><p>Admin Operasional,</p><br><br><p><b>( Dani / Pepik )</b></p></div>
            <div><p>Driver Penerima,</p><br><br><p><b>( ________________ )</b></p></div>
        </div>

        <script>window.onload = function() { window.print(); window.close(); } <\/script>
    </body>
    </html>
    `);
    pWin.document.close();
}


function showMainApp() {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    document.getElementById('current-user-display').innerText = "üë§ User: " + currentUser;
    
    // --- PROTEKSI MENU SETTING ---
    // Tombol Setting Akun HANYA muncul jika user adalah "Admin"
    const btnSetting = document.querySelector('.btn-orange[onclick="openAccountSettings()"]');
    if (currentUser === "Admin") {
        if(btnSetting) btnSetting.style.display = 'inline-flex';
    } else {
        if(btnSetting) btnSetting.style.display = 'none';
    }

    // Pastikan semua card keuangan tampil (karena sudah tidak ada Driver)
    const financeCards = document.querySelectorAll('.card'); 
    financeCards.forEach(c => c.style.display = 'block');
    
    loadData();
}




        // --- ACCOUNT SETTINGS ---
function openAccountSettings() {
    // SEKARANG HANYA "Admin" YANG BOLEH MASUK
    if (currentUser !== "Admin") { 
        alert("Akses Ditolak! Hanya Admin Utama yang dapat mengubah password."); 
        return; 
    }
    
    // Isi data password ke input
    document.getElementById('set-pass-dani').value = passwords["Dani"] || "123";
    document.getElementById('set-pass-pepik').value = passwords["Pepik"] || "123";
    document.getElementById('set-pass-admin').value = passwords["Admin"] || "madhacker";
    document.getElementById('set-pass-owner').value = passwords["Owner"] || "tisal2026";
    
    document.getElementById('modal-account').style.display = 'block';
}

// 4. Update Fungsi Save Account Settings
function saveAccountSettings() {
    try {
        // Ambil data dari input modal
        const pDany = document.getElementById('set-pass-dani').value;
        const pPepik = document.getElementById('set-pass-pepik').value;
        const pAdmin = document.getElementById('set-pass-admin').value;
        const pOwner = document.getElementById('set-pass-owner').value;

        // Update variabel pusat
        passwords["Dani"] = pDani;
        passwords["Pepik"] = pPepik;
        passwords["Admin"] = pAdmin;
        passwords["Owner"] = pOwner;
        
        // Simpan ke Firebase & LocalStorage
        save(); 
        
        alert("‚úÖ Password diperbarui dan disinkronkan ke Cloud!"); 
        closeModal();
    } catch (error) {
        alert("Terjadi Kesalahan: " + error.message);
        console.error("Detail Error:", error);
    }
}

        // --- DATA SYNC ---
async function saveToCloud() {
    if (buses.length === 0 && schedules.length === 0) return;

    try {
        // Simpan ke folder tisalgroup
        await db.ref("tisalgroup").set({
            buses,
            schedules,
            expenses,
            passwords
        });
        console.log("‚úÖ Tisal Cloud Updated");
    } catch (err) {
        console.error("‚ùå Tisal Cloud Error:", err);
    }
}

        function save() {
            localStorage.setItem(KEYS.BUS, JSON.stringify(buses));
            localStorage.setItem(KEYS.SCHED, JSON.stringify(schedules));
            localStorage.setItem(KEYS.EXP, JSON.stringify(expenses));
            localStorage.setItem(KEYS.PASS, JSON.stringify(passwords));
            saveToCloud();
        }

function loadData() {
    // Ambil data lokal dulu buat cadangan
    buses = JSON.parse(localStorage.getItem(KEYS.BUS)) || [];
    schedules = JSON.parse(localStorage.getItem(KEYS.SCHED)) || [];
    expenses = JSON.parse(localStorage.getItem(KEYS.EXP)) || [];
    passwords = JSON.parse(localStorage.getItem(KEYS.PASS)) || passwords;
    renderAll();

    // AKTIFKAN REALTIME LISTENER KHUSUS TISAL
    db.ref("tisalgroup").on("value", (snapshot) => {
        const cloud = snapshot.val();
        if (cloud) {
            buses = cloud.buses || [];
            schedules = cloud.schedules || [];
            expenses = cloud.expenses || [];
            passwords = cloud.passwords || passwords;

            localStorage.setItem(KEYS.BUS, JSON.stringify(buses));
            localStorage.setItem(KEYS.SCHED, JSON.stringify(schedules));
            localStorage.setItem(KEYS.EXP, JSON.stringify(expenses));
            localStorage.setItem(KEYS.PASS, JSON.stringify(passwords));

            renderAll(); 
            console.log("Data Tisal Group Sinkron Realtime! üöÄ");
        }
    });
}

        window.onload = () => {
            const session = sessionStorage.getItem(KEYS.USER);
            if (session) { currentUser = session; showMainApp(); }
        };

        // --- CORE UI LOGIC (Index1) ---
        function formatRp(n) { return "Rp " + (parseInt(n)||0).toLocaleString('id-ID'); }
        function renderAll() { renderCalendar(); renderStats(); renderSidebar(); checkLegalAlerts(); }
function closeModal() {
    // Tutup semua elemen dengan class 'modal'
    const modals = document.querySelectorAll('.modal');
    modals.forEach(m => {
        m.style.display = 'none';
    });
    // Reset data sementara agar tidak nyangkut ke modal berikutnya
tempSelectedBuses = []; 
    if(document.getElementById('selected-bus-list')) {
        renderSelectedBuses();
    }
}
        function changeMonth(dir) { currDate.setMonth(currDate.getMonth() + dir); renderAll(); }
        function toggleDP(val) { document.getElementById('dp-group').style.display = (val === 'DP') ? 'block' : 'none'; }

        function renderStats() {
            const mKey = `${currDate.getFullYear()}-${String(currDate.getMonth()+1).padStart(2,'0')}`;
            const fS = schedules.filter(s => s.date.startsWith(mKey));
            const fE = expenses.filter(e => e.date.startsWith(mKey));
            const omzet = fS.reduce((a,b) => a + (parseInt(b.price)||0), 0);
            const masuk = fS.reduce((a,b) => a + (parseInt(b.dp)||0), 0);
            const keluar = fE.reduce((a,b) => a + (parseInt(b.amount)||0), 0);
            document.getElementById('st-omzet').innerText = formatRp(omzet);
            document.getElementById('st-piutang').innerText = formatRp(omzet - masuk);
            document.getElementById('st-masuk').innerText = formatRp(masuk);
            document.getElementById('st-keluar').innerText = formatRp(keluar);
            document.getElementById('st-laba').innerText = formatRp(masuk - keluar);
            
            const tbody = document.getElementById('list-expenses-body'); tbody.innerHTML = '';
            fE.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e => {
                const b = buses.find(x => x.id == e.busId);
                tbody.innerHTML += `<tr><td style="padding:10px">${e.date}</td><td>${b?.name||'Kantor'}</td><td>${e.cat}</td><td>${e.desc||'-'}</td><td align="right">${formatRp(e.amount)}</td><td align="center"><button class="btn-red" style="padding:4px" onclick="deleteExpense(${e.id})">üóëÔ∏è</button></td></tr>`;
            });
            updateFinanceChart(omzet, masuk, keluar, masuk-keluar);
        }

        function updateFinanceChart(o, m, k, l) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Target', 'Masuk', 'Biaya', 'Laba'],
                    datasets: [{ label: 'Rp', data: [o, m, k, l], backgroundColor: ['#005a9c', '#28a745', '#dc3545', '#fd7e14'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }


        function renderStats() {
            const mKey = `${currDate.getFullYear()}-${String(currDate.getMonth()+1).padStart(2,'0')}`;
            const fS = schedules.filter(s => s.date.startsWith(mKey));
            const fE = expenses.filter(e => e.date.startsWith(mKey));
            const omzet = fS.reduce((a,b) => a + (parseInt(b.price)||0), 0);
            const masuk = fS.reduce((a,b) => a + (parseInt(b.dp)||0), 0);
            const keluar = fE.reduce((a,b) => a + (parseInt(b.amount)||0), 0);
            const laba = masuk - keluar;
            document.getElementById('st-omzet').innerText = formatRp(omzet);
            document.getElementById('st-piutang').innerText = formatRp(omzet - masuk);
            document.getElementById('st-masuk').innerText = formatRp(masuk);
            document.getElementById('st-keluar').innerText = formatRp(keluar);
            document.getElementById('st-laba').innerText = formatRp(laba);
            renderExpensesTable(fE);
            updateFinanceChart(omzet, masuk, keluar, laba);
        }

        function renderExpensesTable(fE) {
            const tbody = document.getElementById('list-expenses-body'); tbody.innerHTML = '';
            fE.sort((a,b) => b.date.localeCompare(a.date)).forEach(e => {
                const b = buses.find(x => x.id == e.busId);
                tbody.innerHTML += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${e.date}</td><td style="padding:10px; border-bottom:1px solid #eee;">${b?.name || 'Kantor'}</td><td style="padding:10px; border-bottom:1px solid #eee;"><span class="badge" style="background:#eee;color:var(--dark)">${e.cat}</span></td><td style="padding:10px; border-bottom:1px solid #eee;">${e.desc || '-'}</td><td style="padding:10px; border-bottom:1px solid #eee; text-align:right"><b>${formatRp(e.amount)}</b></td><td style="padding:10px; border-bottom:1px solid #eee; text-align:center; display:flex; gap:5px; justify-content:center;"><button class="btn-orange" style="padding:4px 8px" onclick="editExpense(${e.id})">‚úèÔ∏è</button><button class="btn-red" style="padding:4px 8px" onclick="deleteExpense(${e.id})">üóëÔ∏è</button></td></tr>`;
            });
        }


function openBusStatsModal() {
    const tbody = document.getElementById('bus-performance-body');
    const monthSelect = document.getElementById('stats-month-filter');
    const yearSelect = document.getElementById('stats-year-filter');
    
    // --- FITUR AUTO TAHUN ---
    // Jika dropdown tahun masih kosong, kita isi otomatis
    if (yearSelect.options.length === 0) {
        const currentYear = new Date().getFullYear();
        const years = new Set();
        
        // Tambahkan tahun dari data jadwal yang ada
        schedules.forEach(s => years.add(new Date(s.date).getFullYear()));
        
        // Tambahkan tahun sekarang dan tahun depan agar selalu update
        years.add(currentYear);
        years.add(currentYear + 1);

        // Urutkan tahun dari yang terbaru
        const sortedYears = Array.from(years).sort((a, b) => b - a);
        
        sortedYears.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.text = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.add(opt);
        });
    }
    // ------------------------

    const selectedMonth = monthSelect.value;
    const selectedYear = yearSelect.value;
    tbody.innerHTML = '';

// Update Header Tabel nambah kolom Aksi
    const thead = document.querySelector('#modal-bus-stats thead tr');
    if (!thead.innerHTML.includes('Aksi')) {
        thead.innerHTML += '<th style="padding:10px;">Aksi</th>';
    }

    buses.forEach(bus => {
        const busJobs = schedules.filter(s => {
            const d = new Date(s.date);
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const y = String(d.getFullYear());
            return s.busId == bus.id && (selectedMonth === 'all' || m === selectedMonth) && y === selectedYear;
        });

        const busExps = expenses.filter(e => {
            const d = new Date(e.date);
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const y = String(d.getFullYear());
            return e.busId == bus.id && (selectedMonth === 'all' || m === selectedMonth) && y === selectedYear;
        });

        const totalOmzet = busJobs.reduce((sum, s) => sum + (Number(s.price) || 0), 0);
        const totalKeluar = busExps.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        const profit = totalOmzet - totalKeluar;

        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding:12px;"><b>${bus.name}</b><br><small>${bus.plate}</small></td>
                <td align="center">${busJobs.length}</td>
                <td align="right">${formatRp(totalOmzet)}</td>
                <td align="right" style="color:var(--danger)">${formatRp(totalKeluar)}</td>
                <td align="right" style="font-weight:bold; color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    ${formatRp(profit)}
                </td>
                <td align="center">
                    <button class="btn-blue" style="padding: 5px 10px;" onclick="viewBusExpDetail(${bus.id}, '${bus.name}')">üîç Detail Ops</button>
                </td>
            </tr>
        `;
    });

    document.getElementById('modal-bus-stats').style.display = 'block';
}



function viewBusExpDetail(busId, busName) {
    const monthSelect = document.getElementById('stats-month-filter');
    const yearSelect = document.getElementById('stats-year-filter');
    const selectedMonth = monthSelect.value;
    const selectedYear = yearSelect.value;

    // Filter biaya khusus bus ini di periode terpilih
    const busExps = expenses.filter(e => {
        const d = new Date(e.date);
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const y = String(d.getFullYear());
        return e.busId == busId && (selectedMonth === 'all' || m === selectedMonth) && y === selectedYear;
    });

    if (busExps.length === 0) {
        alert(`Tidak ada rincian pengeluran untuk ${busName} pada periode ini.`);
        return;
    }

    // Buat tampilan rincian dalam bentuk teks rapi (atau bisa dikembangkan ke modal baru)
    let detailMsg = `--- RINCIAN BIAYA ${busName.toUpperCase()} ---\n\n`;
    busExps.sort((a,b) => b.date.localeCompare(a.date)).forEach(e => {
        detailMsg += `üìå ${formatDateDisplay(e.date)} | ${e.cat}\n`;
        detailMsg += `   Ket: ${e.desc || '-'}\n`;
        detailMsg += `   Nominal: ${formatRp(e.amount)}\n\n`;
    });
    
    const total = busExps.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    detailMsg += `--------------------------------\n`;
    detailMsg += `TOTAL PENGELUARAN: ${formatRp(total)}`;

    alert(detailMsg);
}



function exportBusStatsToExcel() {
    try {
        const monthSelect = document.getElementById('stats-month-filter');
        const yearSelect = document.getElementById('stats-year-filter');
        const mName = monthSelect.options[monthSelect.selectedIndex].text;
        const year = yearSelect.value;
        const selectedMonth = monthSelect.value;

        let mainTableRows = "";
        let detailTables = "";

        buses.forEach(bus => {
            // Filter Data untuk Ringkasan
            const busJobs = schedules.filter(s => {
                const d = new Date(s.date);
                return s.busId == bus.id && (selectedMonth === 'all' || String(d.getMonth() + 1).padStart(2,'0') === selectedMonth) && String(d.getFullYear()) === year;
            });

            const busExps = expenses.filter(e => {
                const d = new Date(e.date);
                return e.busId == bus.id && (selectedMonth === 'all' || String(d.getMonth() + 1).padStart(2,'0') === selectedMonth) && String(d.getFullYear()) === year;
            });

            const omzet = busJobs.reduce((sum, s) => sum + (Number(s.price) || 0), 0);
            const keluar = busExps.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const profit = omzet - keluar;

            // Baris untuk Tabel Utama (Ringkasan)
            mainTableRows += `
                <tr>
                    <td>${bus.name}</td>
                    <td>${bus.plate}</td>
                    <td align="center">${busJobs.length}</td>
                    <td align="right">${omzet}</td>
                    <td align="right">${keluar}</td>
                    <td align="right" style="font-weight:bold;">${profit}</td>
                </tr>`;

            // Membuat Tabel Rincian per Bus (Detail Pengeluaran)
            if (busExps.length > 0) {
                detailTables += `
                    <br>
                    <table border="1">
                        <thead>
                            <tr style="background-color: #f1f5f9;">
                                <th colspan="4" align="left">RINCIAN PENGELUARAN: ${bus.name.toUpperCase()} (${bus.plate})</th>
                            </tr>
                            <tr style="background-color: #eeeeee;">
                                <th width="100">Tanggal</th>
                                <th width="150">Kategori</th>
                                <th width="250">Keterangan</th>
                                <th width="120">Nominal (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${busExps.map(e => `
                                <tr>
                                    <td align="center">${formatDateDisplay(e.date)}</td>
                                    <td>${e.cat}</td>
                                    <td>${e.desc || '-'}</td>
                                    <td align="right">${e.amount}</td>
                                </tr>
                            `).join('')}
                            <tr style="background-color: #fff8e1; font-weight:bold;">
                                <td colspan="3" align="right">TOTAL PENGELUARAN ${bus.name}</td>
                                <td align="right">${keluar}</td>
                            </tr>
                        </tbody>
                    </table>`;
            } else {
                detailTables += `<p><i>* Tidak ada riwayat pengeluaran untuk ${bus.name} di periode ini.</i></p>`;
            }
        });

        const template = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"></head>
            <body>
                <h2 style="color: #005a9c;">LAPORAN ANALISA ARMADA - TISAL GROUP</h2>
                <p>Periode: <b>${mName} ${year}</b></p>
                
                <h3>A. RINGKASAN PERFORMA</h3>
                <table border="1">
                    <thead>
                        <tr style="background-color: #005a9c; color: white;">
                            <th>Nama Unit</th>
                            <th>No. Polisi</th>
                            <th>Total Job</th>
                            <th>Total Omzet (Rp)</th>
                            <th>Total Biaya Ops (Rp)</th>
                            <th>Profit Bersih (Rp)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mainTableRows}
                    </tbody>
                </table>

                <br>
                <h3>B. RINCIAN BIAYA PER UNIT</h3>
                ${detailTables}
                
                <br>
                <p><i>Laporan ini dihasilkan secara otomatis oleh Smart Bus Manager v4.0 pada ${new Date().toLocaleString('id-ID')}</i></p>
            </body>
            </html>`;

        const blob = new Blob([template], { type: 'application/vnd.ms-excel' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Analisa_Armada_Tisal_${mName}_${year}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (e) {
        alert("Gagal Export: " + e.message);
    }
}




        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const y = currDate.getFullYear(), m = currDate.getMonth();
            document.getElementById('month-year').innerText = currDate.toLocaleString('id-ID', {month:'long', year:'numeric'});
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();
            ['Ahad','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'].forEach(d => grid.innerHTML += `<div align="center" style="font-size:0.9rem; font-weight:bold; color:#888;">${d}</div>`);
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="day empty"></div>`;
            for(let i=1; i<=last; i++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'day'; dayEl.innerHTML = `<b>${i}</b>`;
				
// Filter bus yang sedang jalan di tanggal dStr (Cek rentang tanggal)
schedules.filter(s => dStr >= s.date && dStr <= (s.dateEnd || s.date)).forEach(s => {
    const busData = buses.find(b => b.id == s.busId);
    const busName = busData ? busData.name : 'No Bus';
    const color = s.status === 'Lunas' ? 'var(--success)' : (s.status === 'DP' ? 'var(--warning)' : 'var(--danger)');
    
    dayEl.innerHTML += `
        <div class="event" style="background:${color}; text-align:left; font-size:0.75rem; padding:4px; line-height:1.2; margin-top:3px; border-radius:4px;">
            <div style="font-weight:bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${s.trip}
            </div>
            <div style="font-size:0.6rem; opacity:0.9;">
                ${s.time}-${s.timeEnd} | ${busName}
            </div>
        </div>`;
});

                dayEl.onclick = () => openScheduleModal(dStr); grid.appendChild(dayEl);
            }
        }



// --- FUNGSI FILTER & SIDEBAR (REPLACE DI SINI) ---
function renderSidebar() {
    const up = document.getElementById('list-upcoming');
    if (!up) return; // Proteksi agar tidak error

    up.innerHTML = ''; 
    
    const searchInput = document.getElementById('search-input');
    const searchText = searchInput ? searchInput.value.toLowerCase() : '';
    const fStart = document.getElementById('filter-start').value;
    const fEnd = document.getElementById('filter-end').value;
    const today = new Date().toISOString().split('T')[0];

    // FUNGSI PENCARIAN PINTAR
const isSearchMatch = (s) => {
        if (!searchText) return true;
        
        const b = buses.find(x => x.id == s.busId);
        const busName = b ? b.name.toLowerCase() : '';
        const busPlate = b ? b.plate.toLowerCase() : '';
        const creator = s.createdBy ? s.createdBy.toLowerCase() : '';
        const statusBayar = s.status ? s.status.toLowerCase() : '';

        // LOGIKA BARU: Jika kata kunci adalah status (Lunas/DP/Belum), 
        // maka harus COCOK PERSIS dengan kolom status (bukan alamat/nama)
        if (['lunas', 'dp', 'belum bayar'].includes(searchText)) {
            return statusBayar === searchText;
        }

        // Jika bukan mencari status, jalankan pencarian bebas seperti biasa
        return (
            s.cust.toLowerCase().includes(searchText) || 
            s.trip.toLowerCase().includes(searchText) || 
            (s.addr && s.addr.toLowerCase().includes(searchText)) || 
            s.phone.includes(searchText) ||
            busName.includes(searchText) || 
            busPlate.includes(searchText) ||
            creator.includes(searchText)
        );
    };

    // Filter hanya untuk JADWAL TERDEKAT
    let upcomingData = schedules.filter(s => {
        const matchSearch = isSearchMatch(s);
        let matchDate = (fStart && fEnd) ? (s.date >= fStart && s.date <= fEnd) : (s.date >= today);
        return matchSearch && matchDate;
    });

    upcomingData.sort((a, b) => a.date.localeCompare(b.date))
        .forEach(s => up.innerHTML += createCardHtml(s, false));
}


function updateNetworkStatus() {
    const statusBox = document.getElementById('network-status');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    if (!statusBox) return;

    if (navigator.onLine) {
        statusBox.style.background = "#eaffea";
        statusBox.style.color = "#155724";
        statusBox.style.borderColor = "#c3e6cb";
        statusDot.style.background = "#28a745";
        statusText.innerText = "ONLINE";
    } else {
        statusBox.style.background = "#f8d7da";
        statusBox.style.color = "#721c24";
        statusBox.style.borderColor = "#f5c6cb";
        statusDot.style.background = "#dc3545";
        statusText.innerText = "OFFLINE";
    }
}

// Pantau perubahan koneksi
window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);

// Jalankan saat pertama kali load
updateNetworkStatus();

function createCardHtml(s, isUnpaidColumn) {
    const b = buses.find(x => x.id == s.busId); 
    const sisa = (parseInt(s.price)||0) - (parseInt(s.dp)||0);
    const badgeClass = s.status === 'Lunas' ? 'badge-lunas' : (s.status === 'DP' ? 'badge-dp' : 'badge-blm');
    
    // --- LOGIKA SURAT JALAN ---
    const totalSJ = (parseInt(s.fuel) || 0) + (parseInt(s.toll) || 0) + (parseInt(s.tips) || 0);
    const sjStatus = totalSJ > 0 
        ? `<small style="font-size: 0.65rem; font-weight: bold; color: #fff; background: #28a745; padding: 4px 6px; border-radius: 4px; white-space: nowrap;">‚úîÔ∏è SJ TERISI</small>` 
        : `<small style="font-size: 0.65rem; font-weight: bold; color: #fff; background: #dc3545; padding: 4px 6px; border-radius: 4px; white-space: nowrap;">‚ùå SJ KOSONG</small>`;

    // --- SKRIP PEMBATASAN UNTUK AGUS ---
    let sisaHtml = "";
    if (currentUser !== "Agus") {
        sisaHtml = `
        <div style="margin-top:10px; border-top:1px dashed #eee; padding-top:8px;">
            <div style="font-weight:bold; font-size: 0.8rem; color:${sisa > 0 ? 'var(--danger)' : 'var(--success)'}">
                ${sisa > 0 ? 'Sisa Tagihan: ' + formatRp(sisa) : 'SUDAH LUNAS'}
            </div>
        </div>`;
    }
    
    return `
<div class="info-item" style="border-left-color: ${isUnpaidColumn ? 'var(--danger)' : 'var(--primary)'}">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 10px;">
        <strong style="font-size: 1.2rem; flex: 1; padding-right: 10px;">${s.trip}</strong> 
        
        <div style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap; justify-content: flex-end;">
            ${sjStatus}
            
            <small style="font-size: 0.65rem; font-weight: bold; color: #555; background: #f0f0f0; padding: 4px 6px; border-radius: 4px; border: 1px solid #ddd; white-space: nowrap;">
                ${s.paymentMethod === 'Transfer' ? 'üì± TRANSFER' : 'üíµ TUNAI'}
            </small>
            <span class="badge ${badgeClass}" style="font-size: 0.75rem; white-space: nowrap; margin: 0;">
                ${s.status}
            </span>
        </div>

    </div> 
    
    <div class="detail-row" style="font-size: 0.9rem;"> 
        <span>üìÖ <b>Waktu:</b> ${formatDateDisplay(s.date)} (${s.time}) s/d ${formatDateDisplay(s.dateEnd)} (${s.timeEnd})</span>
<div style="font-size: 0.75rem; color: var(--primary); font-weight: bold; margin-bottom: 5px;">
    ‚è≥ Durasi: ${s.duration || 1} Hari
</div>
        <span>üöå <b>Bus:</b> ${b?.name || '-'}</span>
        <span style="display: flex; justify-content: space-between; width: 100%;">
            <span>üë§ <b>Pemesan:</b> ${s.cust}</span>
            <span style="color: var(--primary); font-weight: 500;">üìû ${s.phone}</span>
        </span>
    </div>

    <div class="pickup-box" style="font-size: 0.8rem;">üìç <b>Jemput:</b> ${s.pickup || '-'}</div>
    
    <span class="badge badge-user" style="font-size: 0.8rem;">‚úçÔ∏è Oleh: ${s.createdBy || 'System'}</span>
    
    ${sisaHtml}
    
    <div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap; font-size: 0.85rem;">
        <button class="btn-orange" onclick="editSched(${s.id})">‚úèÔ∏è Edit</button>
        <button class="btn-gray" onclick="printInvoice(${s.id})">üìÑ Kwitansi</button>
        <button class="btn-blue" onclick="openSuratJalanModal(${s.id})">üöö Surat Jalan</button>
        <button class="btn-green" onclick="sendWA(${s.id})">üì± WA</button>
        <button class="btn-red" onclick="delSched(${s.id})">üóëÔ∏è Hapus</button>
    </div>
</div>`;
}



function openScheduleModal(date = '', isEdit = false) {
    if (!isEdit) {
        document.getElementById('edit-id').value = '';
        document.getElementById('schedule-form').reset();
        document.getElementById('sched-modal-title').innerText = "Input Jadwal Sewa";
        document.getElementById('dp-group').style.display = 'none';
        document.getElementById('f-bus-input').value = ''; 
        document.getElementById('f-time').value = "08:00";
        document.getElementById('f-time-end').value = "17:00";
        document.getElementById('f-duration').innerText = "1";
    }

    if(date) {
        document.getElementById('f-date').value = date;
        if(!isEdit) document.getElementById('f-date-end').value = date;
    }
    
    // TAMPILKAN SEMUA BUS (Tanpa Filter Keluar)
    const busOptions = document.getElementById('bus-options');
    busOptions.innerHTML = buses.map(b => 
        `<option value="${b.name} (${b.plate})" data-id="${b.id}">`
    ).join('');

    document.getElementById('modal-form').style.display = 'block';
}


function saveSchedule(e) {
    e.preventDefault();
    
    // ... (ambil data dari form seperti biasa) ...
    const tStart = new Date(`${fDate}T${fTime}`);
    const tEnd = new Date(`${fDateEnd}T${fTimeEnd}`);

    // Cek ulang apakah bus sudah ada yang pakai di jam tersebut
    const isOverlap = schedules.some(s => {
        if (s.id == editId) return false;
        if (String(s.busId) !== String(selectedBusId)) return false;

        const sStart = new Date(`${s.date}T${s.time}`);
        const sEnd = new Date(`${s.dateEnd}T${s.timeEnd}`);

        return (tStart < sEnd && tEnd > sStart);
    });

    if (isOverlap) {
        alert("‚ùå Bus ini sudah dipesan pada waktu tersebut! Silakan pilih bus lain atau ganti jam.");
        return; // Berhenti, jangan simpan
    }

    // ... (lanjutkan proses simpan data jika tidak overlap) ...
}


// FUNGSI HITUNG DURASI (Tambahkan di bawah openScheduleModal)
function calculateDuration() {
    const start = document.getElementById('f-date').value;
    const end = document.getElementById('f-date-end').value;
    const info = document.getElementById('f-duration');
    if (start && end) {
        const d1 = new Date(start);
        const d2 = new Date(end);
        const diffTime = d2 - d1;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        if (d2 < d1) {
            alert("Tanggal pulang tidak boleh sebelum tanggal berangkat!");
            document.getElementById('f-date-end').value = start;
            info.innerText = "1";
        } else { info.innerText = diffDays; }
    }
}

document.getElementById('schedule-form').onsubmit = (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-id').value;
    const busIds = document.getElementById('f-bus-ids').value.split(',').filter(x => x);
    
    if (busIds.length === 0) { alert("Pilih minimal satu bus!"); return; }

    const fDate = document.getElementById('f-date').value;
    const fDateEnd = document.getElementById('f-date-end').value;
    const fTime = document.getElementById('f-time').value;
    const fTimeEnd = document.getElementById('f-time-end').value;

    const tStartNew = new Date(`${fDate}T${fTime}`);
    const tEndNew = new Date(`${fDateEnd}T${fTimeEnd}`);

    let adaYangBentrok = false;
    let namaBusBentrok = "";

    busIds.forEach(bId => {
        const bentrok = schedules.some(s => {
            if (s.id == id) return false;
            const sBusIds = s.busIds || [s.busId]; 
            if (!sBusIds.includes(bId)) return false;
            const tStartExisting = new Date(`${s.date}T${s.time}`);
            const tEndExisting = new Date(`${s.dateEnd || s.date}T${s.timeEnd || '23:59'}`);
            return (tStartNew < tEndExisting && tEndNew > tStartExisting);
        });
        if (bentrok) {
            adaYangBentrok = true;
            const b = buses.find(x => x.id == bId);
            namaBusBentrok = b ? b.name : bId;
        }
    });

    if (adaYangBentrok) {
        alert(`‚ùå GAGAL SIMPAN!\nBus ${namaBusBentrok} sudah ada jadwal di jam tersebut.`);
        return;
    }

    const data = { 
        id: id ? parseInt(id) : Date.now(), 
        trip: document.getElementById('f-trip').value, 
        date: fDate, dateEnd: fDateEnd,
        time: fTime, timeEnd: fTimeEnd,
        duration: document.getElementById('f-duration').innerText,
        busIds: busIds, busId: busIds[0],
        cust: document.getElementById('f-cust').value,
        phone: document.getElementById('f-phone').value, 
        addr: document.getElementById('f-addr').value, 
        pickup: document.getElementById('f-pickup').value, 
        price: parseInt(document.getElementById('f-price').value), 
        status: document.getElementById('f-status').value, 
        dp: parseInt(document.getElementById('f-dp').value) || 0,
        paymentMethod: document.getElementById('f-payment-method').value,
        seats: document.getElementById('f-seats').value,
        extraFeatures: document.getElementById('f-extra-features').value,
        createdBy: currentUser
    };
    
    if(data.status === 'Lunas') data.dp = data.price;
    if(id) { schedules = schedules.map(s => s.id == id ? data : s); } 
    else { schedules.push(data); }
    
    save(); closeModal(); renderAll();
};

function openFleetModal() {
    closeModal();
    renderFleetList();
    document.getElementById('modal-fleet').style.display = 'block';
}


function openExportModal() {
    closeModal();
    document.getElementById('modal-export').style.display = 'block';
}

function openSuratJalanModal(id) {
    const s = schedules.find(x => x.id == id);
    if (!s) return;
    closeModal();
    document.getElementById('sj-id').value = s.id;
    document.getElementById('sj-fuel').value = s.fuel || 0;
    document.getElementById('sj-toll').value = s.toll || 0;
    document.getElementById('sj-tips').value = s.tips || 0;
    document.getElementById('sj-note').value = s.sjNote || '';
    document.getElementById('modal-surat-jalan').style.display = 'block';
}

function editSched(id) {
    const s = schedules.find(x => x.id == id); 
    if (!s) return;
    closeModal();
    tempSelectedBuses = []; 
    const currentBusIds = s.busIds || [s.busId];
    currentBusIds.forEach(bId => {
        const b = buses.find(x => x.id == bId);
        if(b) tempSelectedBuses.push({ id: b.id, name: `${b.name} (${b.plate})` });
    });
    renderSelectedBuses();

    document.getElementById('edit-id').value = s.id; 
    document.getElementById('sched-modal-title').innerText = "Edit Jadwal Sewa";
    openScheduleModal(s.date, true);

    document.getElementById('f-trip').value = s.trip || '';
    document.getElementById('f-date').value = s.date || '';
    document.getElementById('f-time').value = s.time || '08:00';
    document.getElementById('f-date-end').value = s.dateEnd || s.date;
    document.getElementById('f-time-end').value = s.timeEnd || '17:00';
    document.getElementById('f-duration').innerText = s.duration || '1';
    document.getElementById('f-cust').value = s.cust || '';
    document.getElementById('f-phone').value = s.phone || '';
    document.getElementById('f-addr').value = s.addr || '';
    document.getElementById('f-pickup').value = s.pickup || '';
    document.getElementById('f-price').value = s.price || 0;
    document.getElementById('f-status').value = s.status || 'Belum Bayar';
    document.getElementById('f-payment-method').value = s.paymentMethod || 'Tunai';
    toggleDP(s.status); 
    document.getElementById('f-dp').value = s.dp || 0;
    document.getElementById('f-seats').value = s.seats || '';
    document.getElementById('f-extra-features').value = s.extraFeatures || '';
}

function formatDateDisplay(dateStr) {
    if (!dateStr) return "-";
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

function setQuickFilter(status) {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = status; 
        renderSidebar();
    }
}





        function delSched(id) { if(confirm('Hapus jadwal ini?')) { schedules = schedules.filter(x => x.id !== id); save(); renderAll(); } }
        function toggleDP(val) { document.getElementById('dp-group').style.display = (val === 'DP') ? 'block' : 'none'; }
 
function openExpenseModal() {
    // Jika buka lewat tombol "Tambah", pastikan ID edit di-null-kan
    if (event && event.target.innerText.includes("OPS")) {
        currentEditExpenseId = null; 
        document.getElementById('expense-form').reset();
        document.getElementById('expense-modal-title').innerText = "Catat Biaya Operasional";
    }
    document.getElementById('e-bus').innerHTML = '<option value="0">Kantor / Umum</option>' + buses.map(b => `<option value="${b.id}">${b.name}</option>`).join(''); 
    document.getElementById('modal-expense').style.display = 'block'; 
}

function editExpense(id) {
    // 1. Cari data biaya berdasarkan ID
    const exp = expenses.find(x => x.id == id); 
    if (!exp) return; 

    // 2. Tandai ID yang sedang diedit ke variabel global
    currentEditExpenseId = id; 

    // 3. Buka modal (ini akan mengisi pilihan bus secara otomatis)
    openExpenseModal(); 
    
    // 4. Ubah judul dan isi form dengan data lama
    document.getElementById('expense-modal-title').innerText = "Edit Biaya Operasional";
    document.getElementById('e-date').value = exp.date; 
    document.getElementById('e-bus').value = exp.busId; 
    document.getElementById('e-cat').value = exp.cat; 
    document.getElementById('e-amount').value = exp.amount; 
    document.getElementById('e-desc').value = exp.desc; 
}

document.getElementById('expense-form').onsubmit = (e) => {
    e.preventDefault(); 
    
    const data = { 
        date: document.getElementById('e-date').value, 
        busId: document.getElementById('e-bus').value, 
        cat: document.getElementById('e-cat').value, 
        amount: parseInt(document.getElementById('e-amount').value), 
        desc: document.getElementById('e-desc').value 
    };

    // CEK: Apakah ini sedang EDIT atau TAMBAH BARU?
    if (currentEditExpenseId) { 
        // Mode EDIT: Cari index data lama dan timpa
        const index = expenses.findIndex(x => x.id === currentEditExpenseId);
        if (index !== -1) {
            expenses[index] = { ...data, id: currentEditExpenseId }; // Gunakan ID yang sama
        }
    } else { 
        // Mode TAMBAH BARU: Pakai ID baru dari timestamp
        expenses.push({ ...data, id: Date.now() }); 
    }

    save(); // Simpan perubahan
    closeModal(); 
    renderAll(); // Refresh tabel agar data langsung berubah
    
    // Reset variabel global setelah selesai
    currentEditExpenseId = null; 
};


        function deleteExpense(id) { if(confirm('Hapus data biaya ini?')) { expenses = expenses.filter(x => x.id !== id); save(); renderAll(); } }


 function renderFleetList() {
    const listDiv = document.getElementById('fleet-list');
    if (!listDiv) return;

    listDiv.innerHTML = buses.map(b => `
        <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div><b>${b.name}</b> (${b.plate})</div>
            <div style="display:flex; gap:5px;">
                <button type="button" class="btn-orange" style="padding:4px 8px" onclick="editBus(${b.id})">‚úèÔ∏è</button>
                <button type="button" class="btn-red" style="padding:4px 8px" onclick="deleteBus(${b.id})">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}



function autoFillCategory(val) {
    const words = val.trim().split(/\s+/); // Pakai regex biar lebih akurat kalau ada spasi dobel
    if (words.length >= 2) {
        document.getElementById('bus-category').value = words[0] + ' ' + words[1];
    } else {
        document.getElementById('bus-category').value = words[0];
    }
}

document.getElementById('fleet-form').onsubmit = (e) => {
    e.preventDefault(); 
    const id = document.getElementById('bus-edit-id').value;
    
    const data = { 
        id: id ? parseInt(id) : Date.now(), 
        name: document.getElementById('bus-name').value, 
        category: document.getElementById('bus-category').value, // Tambahan baru
        plate: document.getElementById('bus-plate').value, 
        features: document.getElementById('bus-features').value,
        stnk: document.getElementById('bus-stnk').value, 
        kir: document.getElementById('bus-kir').value,
        kps: document.getElementById('bus-kps').value		
    };
    
    if(id) {
        buses = buses.map(b => b.id == id ? data : b);
    } else {
        buses.push(data);
    }
    
    save(); 
    resetFleetForm(); 
    renderFleetList(); 
    renderAll();
    alert("Data armada berhasil diperbarui!");
};

function editBus(id) {
    const b = buses.find(x => x.id == id); 
    if(!b) return;

    document.getElementById('bus-edit-id').value = b.id; 
    document.getElementById('bus-name').value = b.name; 
    document.getElementById('bus-category').value = b.category || ''; // Tambahan baru
    document.getElementById('bus-plate').value = b.plate; 
    document.getElementById('bus-features').value = b.features || ''; 
    document.getElementById('bus-stnk').value = b.stnk || ''; 
    document.getElementById('bus-kir').value = b.kir || '';
    document.getElementById('bus-kps').value = b.kps || '';	
    
document.getElementById('fleet-form-title').innerText = 'Edit Unit Armada'; 
document.getElementById('btn-save-bus').innerText = 'UPDATE UNIT'; 
document.getElementById('btn-cancel-bus').style.display = 'block';
}

        function deleteBus(id) { if(confirm('Hapus unit ini?')) { buses = buses.filter(x => x.id !== id); save(); renderFleetList(); renderAll(); } }
        function resetFleetForm() {
    document.getElementById('fleet-form').reset();
    document.getElementById('bus-edit-id').value = '';
    document.getElementById('fleet-form-title').innerText = 'Tambah Unit Baru';
    document.getElementById('btn-save-bus').innerText = 'SIMPAN UNIT';
    document.getElementById('btn-cancel-bus').style.display = 'none';
}
        function checkLegalAlerts() {
    const container = document.getElementById('legal-alerts');
    if (!container) return;
    container.innerHTML = '';
    
    buses.forEach(b => {
        // Daftar surat yang mau dicek
        const alerts = [
            { label: 'STNK', date: b.stnk },
            { label: 'KIR', date: b.kir },
            { label: 'KPS', date: b.kps }
        ];

        alerts.forEach(a => {
            if (!a.date) return;
            
            const expiryDate = new Date(a.date);
            const today = new Date();
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Jika masa berlaku kurang dari 30 hari atau sudah lewat
            if (diffDays <= 30) {
                const isExpired = diffDays <= 0;
                const bgColor = isExpired ? '#fff5f5' : '#fff9e6';
                const borderColor = isExpired ? '#ff4d4d' : '#ffcc00';
                const textColor = isExpired ? '#d32f2f' : '#856404';

                container.innerHTML += `
                    <div style="padding:10px 15px; background:${bgColor}; border-left:5px solid ${borderColor}; border-radius:6px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:${textColor}; font-weight:bold; font-size:0.9rem;">
                                ‚ö†Ô∏è ${b.name} (${b.plate || 'No Plate'})
                            </span>
                            <span style="font-size:0.7rem; background:${borderColor}; color:white; padding:2px 6px; border-radius:10px;">
                                ${a.label}
                            </span>
                        </div>
                        <p style="margin:5px 0 0 0; font-size:0.8rem; color:#555;">
                            ${isExpired ? '<b>MASA BERLAKU HABIS!</b>' : 'Masa berlaku habis dalam <b>' + diffDays + ' hari</b> lagi.'}
                            <br><small>Tgl Exp: ${a.date}</small>
                        </p>
                    </div>
                `;
            }
        });
    });
}



function sendWA(id) {
    const s = schedules.find(x => x.id == id);
    if (!s) return;

    // --- 1. LOGIKA AMBIL KATEGORI MULTI BUS ---
    const busIds = s.busIds || [s.busId]; 
    const armadaDisplay = busIds.map(bId => {
        const bData = buses.find(x => x.id == bId);
        return bData ? (bData.category || bData.name) : '-';
    }).join(' + ');

    // --- 2. LOGIKA GABUNG FASILITAS (UTAMA + TAMBAHAN) ---
    // Kita ambil semua fasilitas dari tiap bus yang dipilih
    let fasilitasUtama = busIds.map(bId => {
        const bData = buses.find(x => x.id == bId);
        return bData ? bData.features : '';
    }).filter(f => f !== '').join(', '); // Gabungkan fasilitas antar bus jika berbeda

    // Gabungkan dengan fasilitas tambahan dari form jadwal
    const semuaFasilitas = [fasilitasUtama, s.extraFeatures].filter(x => x && x.trim() !== '').join(', ');

    const sisa = s.price - (s.dp || 0);

    // --- 3. SUSUN TEKS PESAN ---
    const pesan = `*KONFIRMASI RESERVASI BUS*
--------------------------------------------
Halo Kak *${s.cust}*, terimakasih telah mempercayakan perjalanan Anda kepada *Tisal Trans Group*.
Berikut adalah rincian reservasi Anda:
--------------------------------------------
üìç *Trip:* ${s.trip}
üìÖ *Berangkat:* ${formatDateDisplay(s.date)} (Jam ${s.time})
üèÅ *Estimasi Pulang:* ${formatDateDisplay(s.dateEnd)} (Jam ${s.timeEnd})
‚è≥ *Durasi:* ${s.duration || 1} Hari
üöå *Armada:* ${armadaDisplay}
üî¢ *Kapasitas:* ${s.seats || '-'} Seat
‚ú® *Fasilitas:* ${semuaFasilitas || '-'}
üìç *Titik Jemput:* ${s.pickup || '-'}
--------------------------------------------
*Rincian Pembayaran:*
üí∞ *Total Harga:* Rp ${s.price.toLocaleString('id-ID')}
‚úÖ *DP/Masuk:* Rp ${(s.dp || 0).toLocaleString('id-ID')}
üî¥ *Sisa Tagihan:* Rp ${sisa.toLocaleString('id-ID')}
üìä *Status:* ${s.status}
--------------------------------------------
*Pembayaran via transfer:*
üè¶ Bank BRI
7477-01-022351-53-0
an. Arif Wahyudi
--------------------------------------------
*Catatan:*
- Mohon pastikan titik jemput sudah sesuai.
- Harap standby 30 menit sebelum keberangkatan.

Jika ada pertanyaan lebih lanjut, silakan hubungi kami kembali. Sampai jumpa di perjalanan! üôèüèª`;

    // BERSIHKAN NOMOR WA
    let phone = s.phone.replace(/\D/g, '');
    if (phone.startsWith('0')) {
        phone = '62' + phone.slice(1);
    }

    const waUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(pesan)}`;
    window.open(waUrl, '_blank');
}


       function printInvoice(id) {
    const s = schedules.find(x => x.id == id), b = buses.find(x => x.id == s.busId);
    const sisa = s.price - s.dp;
    const pWin = window.open('', '_blank');
    
    pWin.document.write(`
    <html>
    <head>
        <title>Kwitansi_${s.cust}_${s.id}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
            body { font-family: 'Inter', sans-serif; padding: 20px; color: #333; background: #f0f0f0; }
            .paper { 
                background: white; width: 210mm; min-height: 148mm; margin: auto; padding: 30px; 
                box-sizing: border-box; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
                position: relative; overflow: hidden;
            }
            /* Watermark Status */
            .watermark { 
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 80px; font-weight: bold; color: rgba(0, 128, 0, 0.1); 
                border: 10px solid rgba(0, 128, 0, 0.1); padding: 20px; border-radius: 20px;
                pointer-events: none; z-index: 0; text-transform: uppercase;
            }
            .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #005a9c; padding-bottom: 15px; }
            .brand h1 { margin: 0; color: #005a9c; font-size: 24px; letter-spacing: 1px; }
            .brand p { margin: 2px 0; font-size: 12px; color: #666; }
            .inv-title { text-align: right; }
            .inv-title h2 { margin: 0; font-size: 28px; color: #444; }
            .inv-title p { margin: 2px 0; font-size: 14px; font-weight: bold; }

            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 25px 0; font-size: 13px; }
            .info-box h4 { margin: 0 0 8px 0; color: #005a9c; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            .info-box p { margin: 4px 0; display: flex; }
            .info-box span { width: 100px; color: #777; flex-shrink: 0; }

            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; z-index: 1; position: relative; }
            th { background: #005a9c; color: white; padding: 12px; text-align: left; }
            td { padding: 12px; border-bottom: 1px solid #eee; }
            
            .footer-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px; }
            .terms { font-size: 11px; color: #777; border: 1px dashed #ccc; padding: 10px; border-radius: 5px; }
            .totals { background: #f9f9f9; padding: 15px; border-radius: 5px; }
            .total-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
            .grand-total { border-top: 2px solid #005a9c; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 18px; color: #005a9c; }

            .signature-area { display: flex; justify-content: space-between; margin-top: 40px; text-align: center; font-size: 13px; }
            .sig-box { width: 200px; }
            .sig-space { height: 70px; }

            @media print {
                body { background: white; padding: 0; }
                .paper { box-shadow: none; border: none; width: 100%; }
                button { display: none; }
            }
        </style>
    </head>
    <body>
        <div class="paper">
            ${s.status === 'Lunas' ? '<div class="watermark">LUNAS</div>' : ''}
            ${s.status === 'DP' ? '<div class="watermark" style="color:rgba(255,165,0,0.1); border-color:rgba(255,165,0,0.1)">DP PAID</div>' : ''}
            
            <div class="header">
                <div class="brand">
                    <h1>PT. Tisal Trans Group</h1>
                    <p>Jl. Raya Krajan - Semin (Tugu Pokah) Ngelo, Candi Rejo, Semin, Gunungkidul</p>
                    <p>Admin1 : 0856-0194-7668 | Admin2 : 0852-8488-0002 | Office : 0896-2538-2277</p>
                </div>
                <div class="inv-title">
                    <h2>KWITANSI</h2>
                    <p>#INV/${s.id}</p>
                    <p>Tgl: ${new Date(s.date).toLocaleDateString('id-ID', {day:'2-digit', month:'long', year:'numeric'})}</p>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <h4>Informasi Penyewa</h4>
                    <p><span>Nama</span>:&nbsp;<b>${s.cust}</b></p>
                    <p><span>Telepon</span>:&nbsp;${s.phone}</p>
                    <p><span>Alamat</span>:&nbsp;${s.addr || '-'}</p>
                </div>
                <div class="info-box">
                    <h4>Detail Perjalanan</h4>
                    <p><span>Tujuan</span>:&nbsp;<b>${s.trip}</b></p>
                    <p><span>Armada</span>:&nbsp;<b>${(s.busIds || [s.busId]).map(bId => {
        const bData = buses.find(x => x.id == bId);
        return bData ? (bData.category || bData.name) : '-';
    }).join(' + ')}
</b></p>
                    <p><span>Kapasitas</span>:&nbsp;${s.seats ? s.seats + ' Seat' : '-'}</p>
					<p><span>Fasilitas</span>:&nbsp;${(() => {
        // Ambil fasilitas utama dari semua bus yang dipilih
        const busIds = s.busIds || [s.busId];
        const fUtama = busIds.map(bId => {
            const bData = buses.find(x => x.id == bId);
            return bData ? bData.features : '';
        }).filter(f => f !== '').join(', ');

        // Gabungkan dengan fasilitas tambahan di jadwal
        return [fUtama, s.extraFeatures].filter(x => x && x.trim() !== '').join(', ') || '-';
    })()}</p>
					<p><span>Penjemputan</span>:&nbsp;${s.pickup || '-'}</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Deskripsi Layanan</th>
                        <th style="text-align:right">Harga Sewa</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <b>Sewa Bus Pariwisata</b><br>
                            <small>Periode: ${formatDateDisplay(s.date)} s/d ${formatDateDisplay(s.dateEnd)} (${s.duration || 1} Hari)</small>
                        </td>
                        <td style="text-align:right"><b>${formatRp(s.price)}</b></td>
                    </tr>
                </tbody>
            </table>

            <div class="footer-grid">
                <div class="terms">
                    <b>Syarat & Ketentuan:</b>
                    <ol style="padding-left:15px; margin:5px 0;">
                        <li>Pembayaran DP minimal 10% dari total harga.</li>
                        <li>Pelunasan maksimal Hari H saat keberangkatan.</li>
                        <li>Pembatalan H-7 dikenakan denda 50% dari DP.</li>
                        <li>Kehilangan barang pribadi bukan tanggung jawab kami.</li>
                    </ol>
					
					<div style="margin-top: 15px; padding: 10px; border: 1px solid #005a9c; border-radius: 5px; background: #f0f7ff;">
                        <p style="margin: 0; font-size: 11px; color: #005a9c;"><b>Informasi Pembayaran (Transfer):</b></p>
                        <p style="margin: 5px 0 0 0; font-size: 11px;">
                            üè¶ <b>BANK BRI</b><br>
                            No. Rek&nbsp;: <b>7477-01-022351-53-0</b><br>
                            A.N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <b>ARIF WAHYUDI</b>
                        </p>
                    </div>
                </div>
				
                
                <div class="totals">
                    <div class="total-row"><span>Total Biaya</span><span>${formatRp(s.price)}</span></div>
                    <div class="total-row" style="color:green"><span>Uang Masuk</span><span>${formatRp(s.dp)}</span></div>
                    <div class="total-row grand-total">
                        <span>${sisa > 0 ? 'SISA TAGIHAN' : 'KETERANGAN'}</span>
                        <span>${sisa > 0 ? formatRp(sisa) : 'LUNAS'}</span>
                    </div>
                </div>
            </div>

            <div class="signature-area">
                <div class="sig-box">
                    <p>Hormat Kami,</p>
                    <div class="sig-space"></div>
                    <p><b>( ________________ )</b><br>Admin Operasional</p>
                </div>
                <div class="sig-box">
                    <p>Penyewa,</p>
                    <div class="sig-space"></div>
                    <p><b>( ${s.cust} )</b><br>Customer</p>
                </div>
            </div>
        </div>
        <script>
            // Auto print saat dibuka
            window.onload = function() {
                setTimeout(() => { window.print(); }, 500);
            }
        <\/script>
    </body>
    </html>
    `);
    pWin.document.close();
}



// 2. Fungsi untuk MEMPROSES download Excel (Pastikan namanya sama)
function processExport() {
    try {
        const period = document.getElementById('export-period').value;
        if (!period) return alert("Pilih periode bulan terlebih dahulu!");

        const [year, month] = period.split('-');
        const monthName = new Date(year, month - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' });

        // Filter data berdasarkan periode
        const filteredS = schedules.filter(s => s.date && s.date.startsWith(period));
        const filteredE = expenses.filter(e => e.date && e.date.startsWith(period));

        // Hitung Ringkasan Keuangan
        const totalOmzet = filteredS.reduce((a, b) => a + (Number(b.price) || 0), 0);
        const totalMasuk = filteredS.reduce((a, b) => a + (Number(b.dp) || 0), 0);
        const totalPiutang = totalOmzet - totalMasuk;
        const totalKeluar = filteredE.reduce((a, b) => a + (Number(b.amount) || 0), 0);
        const labaBersih = totalMasuk - totalKeluar;

        // Template HTML dengan Style Warna dan Layout Menarik
        let template = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="UTF-8">
        <style>
            .header-table { font-family: 'Segoe UI', sans-serif; }
            .title { font-size: 18pt; font-weight: bold; color: #005a9c; text-align: center; }
            .subtitle { font-size: 12pt; text-align: center; color: #666; margin-bottom: 20px; }
            table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
            th { background-color: #005a9c; color: white; border: 1px solid #004080; padding: 8px; }
            td { border: 1px solid #ccc; padding: 6px; font-size: 10pt; }
            .bg-summary { background-color: #f8f9fa; font-weight: bold; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .status-lunas { background-color: #d4edda; color: #155724; }
            .status-dp { background-color: #fff3cd; color: #856404; }
            .status-blm { background-color: #f8d7da; color: #721c24; }
            .row-even { background-color: #f2f2f2; }
            .money-green { color: #28a745; font-weight: bold; }
            .money-red { color: #dc3545; font-weight: bold; }
        </style>
        </head>
        <body>
            <div class="title">LAPORAN OPERASIONAL SMART BUS MANAGER</div>
            <div class="subtitle">Periode: ${monthName}</div>
            <br>

            <h3>1. RINGKASAN KEUANGAN (CASH FLOW)</h3>
            <table border="1">
                <tr><td width="250" class="bg-summary">Total Omzet (Target Pendapatan)</td><td class="text-right">${formatRp(totalOmzet)}</td></tr>
                <tr><td class="bg-summary">Total Uang Masuk (Cash In)</td><td class="text-right money-green">${formatRp(totalMasuk)}</td></tr>
                <tr><td class="bg-summary">Total Piutang (Sisa Tagihan)</td><td class="text-right money-red">${formatRp(totalPiutang)}</td></tr>
                <tr><td class="bg-summary">Total Biaya Operasional (Cash Out)</td><td class="text-right" style="color:#666;">${formatRp(totalKeluar)}</td></tr>
                <tr style="background-color: #e7f3ff; font-size: 12pt;">
                    <td><strong>LABA BERSIH (Uang Masuk - Biaya)</strong></td>
                    <td class="text-right"><strong>${formatRp(labaBersih)}</strong></td>
                </tr>
            </table>

            <br>
            <h3>2. DETAIL JADWAL PERJALANAN</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Tgl Berangkat</th>
                        <th>Tujuan / Trip</th>
                        <th>Pelanggan</th>
                        <th>Unit Bus</th>
                        <th>Harga Sewa</th>
                        <th>DP / Masuk</th>
                        <th>Sisa</th>
                        <th>Status</th>
						<th>Metode</th> <th>Admin/Input Oleh</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredS.map((s, index) => {
                        const b = buses.find(bx => bx.id == s.busId);
                        const sisa = (Number(s.price) || 0) - (Number(s.dp) || 0);
                        const rowClass = index % 2 === 0 ? '' : 'row-even';
                        const stClass = s.status === 'Lunas' ? 'status-lunas' : (s.status === 'DP' ? 'status-dp' : 'status-blm');
                        return `
                        <tr class="${rowClass}">
                            <td class="text-center">${formatDateDisplay(s.date)}</td>
                            <td>${s.trip || '-'}</td>
                            <td>${s.cust || '-'}</td>
                            <td>${b ? b.name : '-'} (${b ? b.plate : '-'})</td>
                            <td class="text-right">${Number(s.price) || 0}</td>
                            <td class="text-right">${Number(s.dp) || 0}</td>
                            <td class="text-right ${sisa > 0 ? 'money-red' : ''}">${sisa}</td>
                            <td class="text-center ${stClass}">${s.status}</td>
							<td class="text-center">${s.paymentMethod || 'Tunai'}</td> <td class="text-center">${s.createdBy || '-'}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>

            <br>
            <h3>3. DETAIL PENGELUARAN OPERASIONAL</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Tgl</th>
                        <th>Unit Terkait</th>
                        <th>Kategori</th>
                        <th>Keterangan</th>
                        <th>Nominal</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredE.map((e, index) => {
                        const b = buses.find(bx => bx.id == e.busId);
                        const rowClass = index % 2 === 0 ? '' : 'row-even';
                        return `
                        <tr class="${rowClass}">
                            <td class="text-center">${formatDateDisplay(e.date)}</td>
                            <td>${b ? b.name : 'Kantor/Umum'}</td>
                            <td>${e.cat || '-'}</td>
                            <td>${e.desc || '-'}</td>
                            <td class="text-right">${Number(e.amount) || 0}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
            <br>
            <p style="font-size: 8pt; color: #999;">Dicetak otomatis oleh SMART BUS MANAGER v4.0 pada ${new Date().toLocaleString('id-ID')}</p>
        </body>
        </html>`;

        const blob = new Blob([template], { type: 'application/vnd.ms-excel' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Laporan_Lengkap_${period}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        closeModal();
    } catch (e) {
        alert("Gagal Export: " + e.message);
    }
}


        function exportBackup() {
    // 1. Buat format waktu (YYYY-MM-DD_Jam-Menit)
    const sekarang = new Date();
    const tgl = sekarang.getFullYear() + "-" + 
                String(sekarang.getMonth() + 1).padStart(2, '0') + "-" + 
                String(sekarang.getDate()).padStart(2, '0');
    const jam = String(sekarang.getHours()).padStart(2, '0') + "-" + 
                String(sekarang.getMinutes()).padStart(2, '0');
    
    const namaFile = `backup_tisal_${tgl}_${jam}.json`;

    // 2. Proses Download
    const data = JSON.stringify({buses, schedules, expenses, passwords});
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    
    a.href = URL.createObjectURL(blob);
    a.download = namaFile; // Nama file sekarang otomatis ada tanggal & jam
    a.click();
    
    // Bersihkan memori
    URL.revokeObjectURL(a.href);
}



        function importData(e) { const r=new FileReader(); r.onload=(ev)=>{ const d=JSON.parse(ev.target.result); buses=d.buses||[]; schedules=d.schedules||[]; expenses=d.expenses||[]; passwords=d.passwords||passwords; save(); renderAll(); }; r.readAsText(e.target.files[0]); }


// Fungsi untuk mengubah format tanggal YYYY-MM-DD menjadi DD/MM/YYYY


function setQuickFilter(status) {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = status; 
        renderSidebar(); // Memanggil fungsi pencarian
    }
}

    </script>
</body>
</html>



